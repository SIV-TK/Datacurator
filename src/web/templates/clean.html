{% extends "base.html" %}

{% block title %}Data Cleaning - Data Curator Pro{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-6 gradient-text mb-2">
                        <i class="bi bi-funnel me-3"></i>Data Cleaning
                    </h1>
                    <p class="text-muted">Clean and enhance your data with advanced AI-powered processing</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#presetsModal">
                        <i class="bi bi-bookmarks me-1"></i> Presets
                    </button>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#helpModal">
                        <i class="bi bi-question-circle me-1"></i> Help
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Cleaning Configuration -->
        <div class="col-lg-8 mb-4">
            <div class="card feature-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-plus-circle me-2"></i>New Cleaning Job
                    </h5>
                </div>
                <div class="card-body">
                    <form id="cleaningForm">
                        <!-- Data Source Selection -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">Data Source</label>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="dataSource" id="fileUpload" value="upload" checked>
                                        <label class="form-check-label" for="fileUpload">
                                            <i class="bi bi-file-earmark-arrow-up me-1"></i>Upload File
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="dataSource" id="existingData" value="existing">
                                        <label class="form-check-label" for="existingData">
                                            <i class="bi bi-database me-1"></i>Existing Dataset
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="dataSource" id="pasteText" value="paste">
                                        <label class="form-check-label" for="pasteText">
                                            <i class="bi bi-clipboard me-1"></i>Paste Text
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- File Upload Section -->
                        <div id="uploadSection" class="mb-4">
                            <label for="dataFile" class="form-label fw-semibold">Select Data File</label>
                            <input class="form-control" type="file" id="dataFile" accept=".json,.jsonl,.txt,.csv">
                            <div class="form-text">Supports JSON, JSONL, CSV, and text files up to 100MB</div>
                        </div>

                        <!-- Existing Data Section -->
                        <div id="existingSection" class="mb-4" style="display: none;">
                            <label for="datasetSelect" class="form-label fw-semibold">Choose Dataset</label>
                            <select class="form-select" id="datasetSelect">
                                <option value="">Loading datasets...</option>
                            </select>
                            <div class="form-text">Select from previously processed or scraped datasets</div>
                        </div>

                        <!-- Text Paste Section -->
                        <div id="pasteSection" class="mb-4" style="display: none;">
                            <label for="textData" class="form-label fw-semibold">Paste Your Data</label>
                            <textarea class="form-control" id="textData" rows="8" 
                                      placeholder="Paste your text data here...&#10;&#10;Supports:&#10;- JSON objects (one per line)&#10;- Plain text&#10;- CSV data"></textarea>
                            <div class="form-text">Paste JSON objects, plain text, or CSV data</div>
                        </div>

                        <!-- Cleaning Options -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-magic me-1"></i>Cleaning Operations
                            </label>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card border-0 bg-light-subtle">
                                        <div class="card-body p-3">
                                            <h6 class="card-title text-primary mb-3">Basic Cleaning</h6>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="removeEmpty" checked>
                                                <label class="form-check-label small" for="removeEmpty">
                                                    Remove empty entries
                                                </label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="removeDuplicates" checked>
                                                <label class="form-check-label small" for="removeDuplicates">
                                                    Remove duplicates
                                                </label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="normalizeWhitespace" checked>
                                                <label class="form-check-label small" for="normalizeWhitespace">
                                                    Normalize whitespace
                                                </label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="removeHtml" checked>
                                                <label class="form-check-label small" for="removeHtml">
                                                    Remove HTML tags
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card border-0 bg-success-subtle">
                                        <div class="card-body p-3">
                                            <h6 class="card-title text-success mb-3">Advanced Processing</h6>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="validateUrls" checked>
                                                <label class="form-check-label small" for="validateUrls">
                                                    Validate URLs
                                                </label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="extractEntities">
                                                <label class="form-check-label small" for="extractEntities">
                                                    Extract named entities
                                                </label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="categorizeContent">
                                                <label class="form-check-label small" for="categorizeContent">
                                                    Categorize content
                                                </label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="qualityScoring" checked>
                                                <label class="form-check-label small" for="qualityScoring">
                                                    Quality scoring
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quality Thresholds -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-3">
                                <input type="checkbox" class="form-check-input me-2" id="showThresholds">
                                <label class="form-check-label fw-semibold" for="showThresholds">
                                    <i class="bi bi-sliders me-1"></i>Quality Thresholds
                                </label>
                            </div>
                            
                            <div id="qualityThresholds" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="minWordCount" class="form-label small">Minimum Word Count</label>
                                            <input type="number" class="form-control form-control-sm" id="minWordCount" value="10" min="0">
                                        </div>
                                        <div class="mb-3">
                                            <label for="maxWordCount" class="form-label small">Maximum Word Count</label>
                                            <input type="number" class="form-control form-control-sm" id="maxWordCount" value="10000" min="0">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="minQualityScore" class="form-label small">Minimum Quality Score</label>
                                            <input type="number" class="form-control form-control-sm" id="minQualityScore" 
                                                   value="0.3" min="0" max="1" step="0.1">
                                        </div>
                                        <div class="mb-3">
                                            <label for="languageFilter" class="form-label small">Language Filter</label>
                                            <select class="form-select form-select-sm" id="languageFilter">
                                                <option value="">Any Language</option>
                                                <option value="en">English</option>
                                                <option value="es">Spanish</option>
                                                <option value="fr">French</option>
                                                <option value="de">German</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Output Configuration -->
                        <div class="mb-4">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="outputFileName" class="form-label fw-semibold">Output File Name</label>
                                    <input type="text" class="form-control" id="outputFileName" 
                                           placeholder="cleaned_data.json">
                                    <div class="form-text">Leave empty for auto-generated filename</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="outputFormat" class="form-label fw-semibold">Output Format</label>
                                    <select class="form-select" id="outputFormat">
                                        <option value="json">JSON</option>
                                        <option value="jsonl">JSONL</option>
                                        <option value="csv">CSV</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg" id="startCleaning">
                                <i class="bi bi-magic me-2"></i>Start Cleaning
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Status & Preview -->
        <div class="col-lg-4 mb-4">
            <!-- Processing Statistics -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-bar-chart me-2"></i>Processing Statistics
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="small">Total Records</span>
                        <strong id="totalRecords">0</strong>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="small">Processed</span>
                        <strong class="text-primary" id="recordsProcessed">0</strong>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="small">Cleaned</span>
                        <strong class="text-success" id="recordsCleaned">0</strong>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="small">Removed</span>
                        <strong class="text-danger" id="recordsRemoved">0</strong>
                    </div>
                </div>
            </div>

            <!-- Progress Card -->
            <div class="card mb-4" id="progressCard" style="display: none;">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-activity me-2"></i>Progress
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Overall Progress</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" id="progressBar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="small text-muted mb-2">
                        <div id="currentStatus">Ready to start...</div>
                    </div>
                    
                    <div class="d-grid">
                        <button class="btn btn-outline-danger btn-sm" id="stopCleaning" style="display: none;">
                            <i class="bi bi-stop-circle me-1"></i>Stop Processing
                        </button>
                    </div>
                </div>
            </div>

            <!-- Data Preview -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="bi bi-eye me-2"></i>Data Preview
                    </h6>
                    <button class="btn btn-sm btn-outline-primary" id="refreshPreview">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div id="dataPreview">
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-file-text display-6"></i>
                            <div class="mt-2">Select data to see preview</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="row mt-4" id="resultsSection" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-check-circle me-2"></i>Cleaning Results
                    </h5>
                    <div>
                        <button class="btn btn-outline-primary btn-sm me-2" id="downloadResults">
                            <i class="bi bi-download me-1"></i>Download
                        </button>
                        <button class="btn btn-outline-success btn-sm me-2" id="enhanceResults">
                            <i class="bi bi-stars me-1"></i>Enhance
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" id="clearResults">
                            <i class="bi bi-trash me-1"></i>Clear
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="resultsContainer"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Presets Modal -->
<div class="modal fade" id="presetsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-bookmarks me-2"></i>Cleaning Presets
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="applyPreset('basic')">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-check-circle me-2"></i>
                            <div class="text-start">
                                <div class="fw-semibold">Basic Cleaning</div>
                                <small class="text-muted">Remove empty, duplicates, normalize text</small>
                            </div>
                        </div>
                    </button>
                    <button class="btn btn-outline-success" onclick="applyPreset('web-content')">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-globe me-2"></i>
                            <div class="text-start">
                                <div class="fw-semibold">Web Content</div>
                                <small class="text-muted">Clean scraped web data, validate URLs</small>
                            </div>
                        </div>
                    </button>
                    <button class="btn btn-outline-warning" onclick="applyPreset('ai-training')">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-robot me-2"></i>
                            <div class="text-start">
                                <div class="fw-semibold">AI Training Data</div>
                                <small class="text-muted">High-quality filtering for ML datasets</small>
                            </div>
                        </div>
                    </button>
                    <button class="btn btn-outline-info" onclick="applyPreset('research')">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-journal-text me-2"></i>
                            <div class="text-start">
                                <div class="fw-semibold">Research Data</div>
                                <small class="text-muted">Academic content processing</small>
                            </div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Help Modal -->
<div class="modal fade" id="helpModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-question-circle me-2"></i>Data Cleaning Help
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6 class="text-primary">🧹 What is Data Cleaning?</h6>
                <p class="small mb-4">
                    Data cleaning removes noise, errors, and inconsistencies from your datasets. 
                    Our AI-powered system can automatically detect and fix common data quality issues.
                </p>

                <h6 class="text-success">✨ Available Operations</h6>
                <div class="row mb-4">
                    <div class="col-md-6">
                        <ul class="small">
                            <li><strong>Remove Empty:</strong> Eliminates blank or null entries</li>
                            <li><strong>Remove Duplicates:</strong> Finds and removes duplicate records</li>
                            <li><strong>Normalize Whitespace:</strong> Standardizes spacing and line breaks</li>
                            <li><strong>Remove HTML:</strong> Strips HTML tags from text content</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="small">
                            <li><strong>Validate URLs:</strong> Checks URL format and accessibility</li>
                            <li><strong>Extract Entities:</strong> Identifies people, places, organizations</li>
                            <li><strong>Categorize Content:</strong> Auto-assigns topic categories</li>
                            <li><strong>Quality Scoring:</strong> Rates content quality (0-1 scale)</li>
                        </ul>
                    </div>
                </div>

                <h6 class="text-warning">⚡ Best Practices</h6>
                <ul class="small">
                    <li>Always preview your data before cleaning</li>
                    <li>Start with basic operations before advanced processing</li>
                    <li>Use quality thresholds to filter low-quality content</li>
                    <li>Save original data before cleaning for comparison</li>
                    <li>Consider using presets for common cleaning scenarios</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentJobId = null;
let progressInterval = null;

document.addEventListener('DOMContentLoaded', function() {
    // Data source toggle
    document.querySelectorAll('input[name="dataSource"]').forEach(radio => {
        radio.addEventListener('change', function() {
            document.getElementById('uploadSection').style.display = 
                this.value === 'upload' ? 'block' : 'none';
            document.getElementById('existingSection').style.display = 
                this.value === 'existing' ? 'block' : 'none';
            document.getElementById('pasteSection').style.display = 
                this.value === 'paste' ? 'block' : 'none';
            
            if (this.value === 'existing') {
                loadDatasets();
            }
        });
    });

    // Quality thresholds toggle
    document.getElementById('showThresholds').addEventListener('change', function() {
        document.getElementById('qualityThresholds').style.display = 
            this.checked ? 'block' : 'none';
    });

    // File input change handler
    document.getElementById('dataFile').addEventListener('change', function() {
        if (this.files.length > 0) {
            previewFile(this.files[0]);
        }
    });

    // Text input change handler
    document.getElementById('textData').addEventListener('input', function() {
        if (this.value.trim()) {
            previewTextData(this.value);
        }
    });

    // Form submission
    document.getElementById('cleaningForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        await startCleaning();
    });

    // Stop cleaning
    document.getElementById('stopCleaning').addEventListener('click', stopCleaning);

    // Refresh preview
    document.getElementById('refreshPreview').addEventListener('click', refreshPreview);
});

async function loadDatasets() {
    try {
        const response = await fetch('/api/datasets');
        const datasets = await response.json();
        
        const select = document.getElementById('datasetSelect');
        select.innerHTML = '<option value="">Select a dataset...</option>';
        
        if (datasets && datasets.length > 0) {
            datasets.forEach(dataset => {
                const option = document.createElement('option');
                option.value = dataset.id;
                option.textContent = `${dataset.name} (${dataset.total_records || 0} records)`;
                select.appendChild(option);
            });
        } else {
            select.innerHTML = '<option value="">No datasets available</option>';
        }
    } catch (error) {
        console.error('Error loading datasets:', error);
        document.getElementById('datasetSelect').innerHTML = 
            '<option value="">Error loading datasets</option>';
    }
}

async function previewFile(file) {
    const preview = document.getElementById('dataPreview');
    preview.innerHTML = `
        <div class="text-center py-3">
            <div class="loading-spinner mb-2"></div>
            <small class="text-muted">Loading preview...</small>
        </div>
    `;

    try {
        const formData = new FormData();
        formData.append('file', file);
        
        const response = await fetch('/api/preview-file', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
            displayPreview(result);
        } else {
            throw new Error(result.detail || 'Failed to preview file');
        }
    } catch (error) {
        preview.innerHTML = `
            <div class="text-center py-3 text-danger">
                <i class="bi bi-exclamation-triangle"></i>
                <div class="mt-2">${error.message}</div>
            </div>
        `;
    }
}

function previewTextData(text) {
    // Simple preview for pasted text
    const lines = text.split('\n').slice(0, 5);
    const preview = {
        sample_data: lines,
        total_records: text.split('\n').length,
        data_type: 'text'
    };
    displayPreview(preview);
}

function displayPreview(data) {
    const preview = document.getElementById('dataPreview');
    
    let previewHTML = `
        <div class="small mb-3">
            <strong>Records:</strong> ${data.total_records || 0} | 
            <strong>Type:</strong> ${data.data_type || 'Unknown'}
        </div>
    `;
    
    if (data.sample_data && data.sample_data.length > 0) {
        previewHTML += '<div class="small"><strong>Sample:</strong></div>';
        previewHTML += '<div class="bg-light p-2 rounded small font-monospace">';
        
        data.sample_data.slice(0, 3).forEach(item => {
            const text = typeof item === 'string' ? item : JSON.stringify(item);
            previewHTML += `<div class="text-truncate">${text}</div>`;
        });
        
        if (data.sample_data.length > 3) {
            previewHTML += '<div class="text-muted">...</div>';
        }
        
        previewHTML += '</div>';
    }
    
    preview.innerHTML = previewHTML;
}

async function startCleaning() {
    const formData = new FormData();
    const dataSource = document.querySelector('input[name="dataSource"]:checked').value;
    
    // Add data source
    if (dataSource === 'upload') {
        const fileInput = document.getElementById('dataFile');
        if (!fileInput.files.length) {
            showToast('Please select a file to clean', 'warning');
            return;
        }
        formData.append('file', fileInput.files[0]);
    } else if (dataSource === 'existing') {
        const datasetId = document.getElementById('datasetSelect').value;
        if (!datasetId) {
            showToast('Please select a dataset', 'warning');
            return;
        }
        formData.append('dataset_id', datasetId);
    } else if (dataSource === 'paste') {
        const textData = document.getElementById('textData').value.trim();
        if (!textData) {
            showToast('Please paste some data to clean', 'warning');
            return;
        }
        formData.append('text_data', textData);
    }

    // Add cleaning options
    const cleaningOptions = {
        remove_empty: document.getElementById('removeEmpty').checked,
        remove_duplicates: document.getElementById('removeDuplicates').checked,
        normalize_whitespace: document.getElementById('normalizeWhitespace').checked,
        remove_html: document.getElementById('removeHtml').checked,
        validate_urls: document.getElementById('validateUrls').checked,
        extract_entities: document.getElementById('extractEntities').checked,
        categorize_content: document.getElementById('categorizeContent').checked,
        quality_scoring: document.getElementById('qualityScoring').checked
    };

    // Add quality thresholds if enabled
    if (document.getElementById('showThresholds').checked) {
        cleaningOptions.min_word_count = parseInt(document.getElementById('minWordCount').value);
        cleaningOptions.max_word_count = parseInt(document.getElementById('maxWordCount').value);
        cleaningOptions.min_quality_score = parseFloat(document.getElementById('minQualityScore').value);
        const langFilter = document.getElementById('languageFilter').value;
        if (langFilter) {
            cleaningOptions.language_filter = langFilter;
        }
    }

    formData.append('cleaning_options', JSON.stringify(cleaningOptions));

    // Add output options
    const outputFileName = document.getElementById('outputFileName').value;
    if (outputFileName) {
        formData.append('output_file', outputFileName);
    }
    formData.append('output_format', document.getElementById('outputFormat').value);

    try {
        // Show progress card
        document.getElementById('progressCard').style.display = 'block';
        document.getElementById('startCleaning').disabled = true;
        document.getElementById('stopCleaning').style.display = 'block';
        
        updateProgress(0, 'Starting cleaning process...');

        const response = await fetch('/api/clean', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (response.ok) {
            currentJobId = result.job_id;
            showToast('Data cleaning started successfully!', 'success');
            
            // Start monitoring progress
            progressInterval = setInterval(checkProgress, 2000);
        } else {
            throw new Error(result.detail || 'Failed to start cleaning job');
        }
    } catch (error) {
        showToast(`Error: ${error.message}`, 'danger');
        resetCleaningForm();
    }
}

async function checkProgress() {
    if (!currentJobId) return;

    try {
        const response = await fetch(`/api/jobs/${currentJobId}`);
        const job = await response.json();

        if (job.status === 'completed') {
            updateProgress(100, 'Cleaning completed successfully!');
            showResults(job.result);
            resetCleaningForm();
            clearInterval(progressInterval);
            showToast('Data cleaning completed!', 'success');
        } else if (job.status === 'failed') {
            updateProgress(0, `Failed: ${job.error || 'Unknown error'}`);
            resetCleaningForm();
            clearInterval(progressInterval);
            showToast('Cleaning job failed', 'danger');
        } else {
            const progress = job.progress || 0;
            updateProgress(progress, job.status_message || 'Processing...');
            
            // Update statistics
            if (job.statistics) {
                updateStatistics(job.statistics);
            }
        }
    } catch (error) {
        console.error('Error checking progress:', error);
    }
}

function updateProgress(percent, message) {
    document.getElementById('progressPercent').textContent = `${Math.round(percent)}%`;
    document.getElementById('progressBar').style.width = `${percent}%`;
    document.getElementById('currentStatus').textContent = message;
}

function updateStatistics(stats) {
    document.getElementById('totalRecords').textContent = stats.total || 0;
    document.getElementById('recordsProcessed').textContent = stats.processed || 0;
    document.getElementById('recordsCleaned').textContent = stats.cleaned || 0;
    document.getElementById('recordsRemoved').textContent = stats.removed || 0;
}

function stopCleaning() {
    if (currentJobId && progressInterval) {
        clearInterval(progressInterval);
        currentJobId = null;
        resetCleaningForm();
        showToast('Cleaning stopped', 'info');
    }
}

function resetCleaningForm() {
    document.getElementById('startCleaning').disabled = false;
    document.getElementById('stopCleaning').style.display = 'none';
    document.getElementById('progressCard').style.display = 'none';
    
    // Reset statistics
    document.getElementById('totalRecords').textContent = '0';
    document.getElementById('recordsProcessed').textContent = '0';
    document.getElementById('recordsCleaned').textContent = '0';
    document.getElementById('recordsRemoved').textContent = '0';
}

function showResults(results) {
    const resultsSection = document.getElementById('resultsSection');
    const container = document.getElementById('resultsContainer');
    
    const summary = results.summary || {};
    const sampleData = results.sample_data || [];
    
    const resultsHTML = `
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="text-center">
                    <div class="display-6 text-primary">${summary.total_cleaned || 0}</div>
                    <div class="small text-muted">Records Cleaned</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <div class="display-6 text-danger">${summary.total_removed || 0}</div>
                    <div class="small text-muted">Records Removed</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <div class="display-6 text-success">${Math.round((summary.quality_improvement || 0) * 100)}%</div>
                    <div class="small text-muted">Quality Improvement</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <div class="display-6 text-info">${summary.processing_time || 0}s</div>
                    <div class="small text-muted">Processing Time</div>
                </div>
            </div>
        </div>
        
        ${sampleData.length > 0 ? `
            <div class="mb-3">
                <h6>Sample Cleaned Data</h6>
                <div class="bg-light p-3 rounded">
                    <pre class="mb-0"><code>${JSON.stringify(sampleData.slice(0, 3), null, 2)}</code></pre>
                </div>
            </div>
        ` : ''}
        
        <div class="text-muted small">
            Output file: <code>${results.output_file || 'cleaned_data.json'}</code>
        </div>
    `;
    
    container.innerHTML = resultsHTML;
    resultsSection.style.display = 'block';
}

function refreshPreview() {
    const dataSource = document.querySelector('input[name="dataSource"]:checked').value;
    
    if (dataSource === 'upload') {
        const fileInput = document.getElementById('dataFile');
        if (fileInput.files.length > 0) {
            previewFile(fileInput.files[0]);
        }
    } else if (dataSource === 'paste') {
        const textData = document.getElementById('textData').value.trim();
        if (textData) {
            previewTextData(textData);
        }
    }
}

function applyPreset(presetName) {
    // Reset all checkboxes first
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        if (cb.id !== 'showThresholds' && cb.id !== 'showAdvanced') {
            cb.checked = false;
        }
    });

    switch (presetName) {
        case 'basic':
            document.getElementById('removeEmpty').checked = true;
            document.getElementById('removeDuplicates').checked = true;
            document.getElementById('normalizeWhitespace').checked = true;
            break;
        case 'web-content':
            document.getElementById('removeEmpty').checked = true;
            document.getElementById('removeDuplicates').checked = true;
            document.getElementById('normalizeWhitespace').checked = true;
            document.getElementById('removeHtml').checked = true;
            document.getElementById('validateUrls').checked = true;
            document.getElementById('qualityScoring').checked = true;
            break;
        case 'ai-training':
            document.getElementById('removeEmpty').checked = true;
            document.getElementById('removeDuplicates').checked = true;
            document.getElementById('normalizeWhitespace').checked = true;
            document.getElementById('removeHtml').checked = true;
            document.getElementById('qualityScoring').checked = true;
            document.getElementById('showThresholds').checked = true;
            document.getElementById('qualityThresholds').style.display = 'block';
            document.getElementById('minWordCount').value = '50';
            document.getElementById('minQualityScore').value = '0.7';
            break;
        case 'research':
            document.getElementById('removeEmpty').checked = true;
            document.getElementById('removeDuplicates').checked = true;
            document.getElementById('normalizeWhitespace').checked = true;
            document.getElementById('extractEntities').checked = true;
            document.getElementById('categorizeContent').checked = true;
            document.getElementById('qualityScoring').checked = true;
            break;
    }

    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('presetsModal')).hide();
    showToast(`Applied ${presetName} preset`, 'success');
}
</script>
{% endblock %}
