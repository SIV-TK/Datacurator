{% extends "base.html" %}

{% block title %}Data Curator - Datasets{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Datasets</h1>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createDatasetModal">
            <i class="bi bi-plus-lg"></i> Create Dataset
        </button>
    </div>
    
    <!-- Dataset List -->
    <div class="card">
        <div class="card-body">
            <div id="datasets-container">
                <div class="spinner-container">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Dataset Detail Panel -->
    <div class="modal fade" id="datasetDetailModal" tabindex="-1" aria-labelledby="datasetDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="datasetDetailModalLabel">Dataset Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="dataset-detail-content">
                        <div class="spinner-container">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create Dataset Modal -->
    <div class="modal fade" id="createDatasetModal" tabindex="-1" aria-labelledby="createDatasetModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createDatasetModalLabel">Create New Dataset</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="create-dataset-form">
                        <div class="mb-3">
                            <label for="dataset-name" class="form-label">Name</label>
                            <input type="text" class="form-control" id="dataset-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="dataset-description" class="form-label">Description</label>
                            <textarea class="form-control" id="dataset-description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="dataset-source-type" class="form-label">Source Type</label>
                            <select class="form-select" id="dataset-source-type" required>
                                <option value="web">Web</option>
                                <option value="file">File</option>
                                <option value="api">API</option>
                                <option value="database">Database</option>
                                <option value="manual">Manual</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="create-dataset-button">Create</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Load datasets
    function loadDatasets() {
        const datasetsContainer = document.getElementById('datasets-container');
        
        fetch('/api/datasets')
            .then(response => response.json())
            .then(data => {
                if (data.length === 0) {
                    datasetsContainer.innerHTML = `
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> No datasets found. Create a new dataset to get started.
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Source</th>
                                    <th>Records</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.forEach(dataset => {
                    html += `
                        <tr>
                            <td>${dataset.id}</td>
                            <td>${dataset.name}</td>
                            <td><span class="badge bg-secondary">${dataset.source_type}</span></td>
                            <td>${dataset.total_records} (${dataset.cleaned_records} cleaned)</td>
                            <td>${formatDate(dataset.created_at)}</td>
                            <td>
                                <button class="btn btn-sm btn-info view-dataset" data-id="${dataset.id}">
                                    <i class="bi bi-eye"></i> View
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                datasetsContainer.innerHTML = html;
                
                // Attach event listeners to view buttons
                document.querySelectorAll('.view-dataset').forEach(button => {
                    button.addEventListener('click', function() {
                        const datasetId = this.getAttribute('data-id');
                        showDatasetDetail(datasetId);
                    });
                });
            })
            .catch(error => {
                console.error('Error loading datasets:', error);
                datasetsContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> Error loading datasets: ${error.message}
                    </div>
                `;
            });
    }
    
    // Show dataset detail
    function showDatasetDetail(datasetId) {
        const modal = new bootstrap.Modal(document.getElementById('datasetDetailModal'));
        modal.show();
        
        const detailContent = document.getElementById('dataset-detail-content');
        detailContent.innerHTML = `
            <div class="spinner-container">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        `;
        
        // Fetch dataset details
        fetch(`/api/datasets/${datasetId}`)
            .then(response => response.json())
            .then(dataset => {
                // Fetch records for this dataset
                return fetch(`/api/datasets/${datasetId}/records`)
                    .then(response => response.json())
                    .then(records => {
                        return { dataset, records };
                    });
            })
            .then(data => {
                const { dataset, records } = data;
                
                let html = `
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h3>${dataset.name}</h3>
                            <p>${dataset.description || 'No description'}</p>
                            <div class="mb-3">
                                <strong>Source Type:</strong> ${dataset.source_type}
                            </div>
                            <div class="mb-3">
                                <strong>Created:</strong> ${formatDate(dataset.created_at)}
                            </div>
                            <div class="mb-3">
                                <strong>Total Records:</strong> ${dataset.total_records}
                            </div>
                            <div class="mb-3">
                                <strong>Cleaned Records:</strong> ${dataset.cleaned_records}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Configuration</h5>
                                </div>
                                <div class="card-body">
                                    <pre class="bg-light p-3 rounded"><code>${JSON.stringify(dataset.config || {}, null, 2)}</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <h4>Records (${records.length})</h4>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Content</th>
                                    <th>Processed</th>
                                    <th>Valid</th>
                                    <th>Quality</th>
                                    <th>Created</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                if (records.length === 0) {
                    html += `
                        <tr>
                            <td colspan="6" class="text-center">No records found</td>
                        </tr>
                    `;
                } else {
                    records.forEach(record => {
                        const contentPreview = record.content.length > 100 
                            ? record.content.substring(0, 100) + '...' 
                            : record.content;
                            
                        const processedPreview = record.processed_content && record.processed_content.length > 100
                            ? record.processed_content.substring(0, 100) + '...'
                            : record.processed_content || 'Not processed';
                            
                        html += `
                            <tr>
                                <td>${record.id}</td>
                                <td>${contentPreview}</td>
                                <td>${processedPreview}</td>
                                <td>${record.is_valid ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-danger">No</span>'}</td>
                                <td>${record.quality_score !== null ? record.quality_score.toFixed(2) : 'N/A'}</td>
                                <td>${formatDate(record.created_at)}</td>
                            </tr>
                        `;
                    });
                }
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                detailContent.innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading dataset details:', error);
                detailContent.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> Error loading dataset details: ${error.message}
                    </div>
                `;
            });
    }
    
    // Create new dataset
    function createDataset() {
        const name = document.getElementById('dataset-name').value;
        const description = document.getElementById('dataset-description').value;
        const sourceType = document.getElementById('dataset-source-type').value;
        
        if (!name) {
            alert('Dataset name is required');
            return;
        }
        
        fetch('/api/datasets', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name,
                description,
                source_type: sourceType,
                config: {}
            }),
        })
        .then(response => response.json())
        .then(data => {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('createDatasetModal'));
            modal.hide();
            
            // Reset form
            document.getElementById('create-dataset-form').reset();
            
            // Reload datasets
            loadDatasets();
        })
        .catch(error => {
            console.error('Error creating dataset:', error);
            alert(`Error creating dataset: ${error.message}`);
        });
    }
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        loadDatasets();
        
        // Set up create dataset form
        document.getElementById('create-dataset-button').addEventListener('click', createDataset);
    });
</script>
{% endblock %}
